name: Deploy 2048 to EKS

on:
    push:
        branches:
            - master
    workflow_dispatch:

permissions:
    id-token: write
    contents: read

env:
    IMAGE_NAME: 2048
    REGISTRY: docker.io

jobs:
    build-and-push:
        name: Build and push docker images
        runs-on: ubuntu-latest
        steps:
            - name: checkout source code
              uses: actions/checkout@v4

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and Push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: |
                      ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
                      ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:latest

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: arn:aws:iam::810044336424:role/GitHubActionsEKSRole
                  aws-region: ap-south-1
            - name: Verify AWS identity
              run: aws sts get-caller-identity

            - name: Update kubeconfig
              run: |
                  aws eks update-kubeconfig \
                  --region ap-south-1 \
                  --name my-eks-2048

            - name: Deploy to EKS
              run: |
                  kubectl rollout restart deployment game-2048 -n game-2048
